<!doctype html>

<html lang="en">
<head>
  <meta charset="utf-8">

  <title>Noetica Hydraulics Test</title>
  <meta name="description" content="Flame Sequence Creator/Editor">

  <!--
  <link rel="stylesheet" href="css/styles.css">
  ->

  <!--[if lt IE 9]>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html5shiv/3.7.3/html5shiv.js"></script>
  <!--[endif]-->
</head>
<style>
.poofer {background-color:grey; width:20px; height:20px; position:absolute;}
.poofer.active {background-color:orange;}
.top-button {font-size:12pt; font-family:sans-serif}
h1 {font-family:sans-serif}

</style>


<body>
<div style="margin:20px">
<div>
    <div style="float:left; width:400px">
    <h1>Noetica Flame Sequence Creator </h1>
    </div>
    <div id="BigNoetica" style="margin-left:400px; position:relative;">
    </div>
</div>
  <!-- Should be able to create new ones, or edit ones that you've already created.-->
  <div id="topControls" style="width: 100%; overflow: hidden;">
  <button type="button" id="createSequenceButton">Create New Sequence</button>
  <button type="button" id="modifySequenceButton">Modify Existing Sequence</button><br>
  </div>
  
  <div id="createSequenceDiv">
      <span name="sequenceDiv" class="top-button" style="margin-bottom:10px">Sequence Name:&nbsp;<input type="text" length="40"></input> <br></span>
      <div name="playDiv" style="margin-top:10px"><button type="button" class="top-button" onclick="playSequence()">Play Sequence</button> &nbsp;
      <button type="button" id="createEventButton" class="top-button"> Create New Event </button>
      </div>
      <div id="EventTemplate" style="display:none; height:160px; border-width:2px; border-style:solid; margin-top:10px; padding:10px" >   
          <span id="eventId"></span>
          <div style="width:800px; height:150px; display:table">
            <div style="display:table-row">
              <div id="NoeticaContainer" style="position:relative; height:150px; display:table-cell; width:300px">
              </div>
              <div style="display:table-cell">
                  Event Starts... &nbsp;<input id="startDelay" type="number" length = "4" width="40" value="0"/>ms&nbsp;
                  <select id="eventStart">
                     <option value="afterPreviousEnd" selected="true">After Previous Event End</option>
                     <option value="afterPreviousStart">After Previous Event Start</option>
                     <option value="absoluteTime">After Sequence Start </option>
                  </select> &nbsp;
                  <br>
                  Event Duration: &nbsp; <input id="duration" type="number" length="4" value="1000" maxvalue="5000"/>ms
                  <div>
                    <button type="button" class="deleteEventButton">Delete Event</button>
                    <button type="button" class="insertEventButton">Insert New Event</button>
                  </div>
              </div
            </div>
          </div>
      </div>
  </div>
  <div id="modifySequenceDiv">
  </div>
  </div>
</body>
</html>

<script type="text/javascript" src="jquery-1.4.3.min.js"></script>

<script type="text/javascript">

console.log("TESTING TESTING");
$(document).ready(function() {
    console.log("READY called");
    $("#modifySequenceButton").hide()
    $("#createSequenceButton").hide()
    $("#modifySequenceDiv").hide()
//    $("#createSequenceDiv").hide()

    insertNoeticaImage($("#BigNoetica"), 25, false);
    createEvent(null);
});


function insertNoeticaImage(parentDiv, boxWidth, allowClicks) {
    // add the damn poofers
    for (i=0; i<7; i++){
        for (j=0; j<11; j++){
            var newDiv = $("<div class='poofer'>");
            newDiv.width(boxWidth-2);
            newDiv.height(boxWidth-2);
            if (allowClicks) {
                newDiv.addClass("pooferActive");
            }
            
            newDiv.css({top: boxWidth*i, left: boxWidth*j});
            if (i==0 && j==3){
                newDiv.attr("id", "NN");
            } else if (i==1) {
                if (j==2){
                    newDiv.attr("id", "NW");
                } else if (j==3){
                    newDiv.attr("id", "NT");
                } else if (j==4){
                    newDiv.attr("id", "NE");
                }
            } else if (i==2) {
                if (j==1) {
                    newDiv.attr("id", "WN");
                } else if (j==3){
                    newDiv.attr("id", "TN");
                } else if (j==5){
                    newDiv.attr("id", "EN");
                } else if (j==9){
                    newDiv.attr("id", "BN");
                }
            } else if (i==3) {
                if (j==0){
                    newDiv.attr("id", "WW");
                } else if (j==1){
                    newDiv.attr("id", "WT");
                } else if (j==2){
                    newDiv.attr("id", "TW");
                } else if (j==3){
                    newDiv.attr("id", "TT");
                } else if (j==4){
                    newDiv.attr("id", "TE");
                } else if (j==5){
                    newDiv.attr("id", "ET");
                } else if (j==6){
                    newDiv.attr("id", "EE");
                } else if (j==8){
                    newDiv.attr("id", "BW");
                } else if (j==10){
                    newDiv.attr("id", "BE");
                }
            } else if (i==4) {
                if (j==1) {
                    newDiv.attr("id", "WS");
                } else if (j==3){
                    newDiv.attr("id", "TS");
                } else if (j==5){
                    newDiv.attr("id", "ES");
                } else if (j==9){
                    newDiv.attr("id", "BT");
                }
            } else if (i==5) {
                if (j==2){
                    newDiv.attr("id", "SW");
                } else if (j==3){
                    newDiv.attr("id", "ST");
                } else if (j==4){
                    newDiv.attr("id", "SE");
                }
            } else if (i==6 && j==3){
                newDiv.attr("id", "SS");
            }
            // Only add the ones that have poofers in them
            if (newDiv.attr("id") != ""){
                parentDiv.append(newDiv);
            }
        }
    }
}

$("#createSequenceButton").click(function(){
    $("#createSequenceDiv").show();
});

$("#addThingButton").live("click", function(){
    var newThing = $("#ThingerTemplate").clone();
    newThing.attr("id", "Thinger");
    
    var parentEvent = $(this).parents(".Event");
    var last = parentEvent.find("#Thinger:last");
    newThing.insertAfter(last);
    
});

$("#deleteThingButton").live("click", function(){
    var thisDelete = $(this);
    var parentThinger = thisDelete.parents("#Thinger");
    parentThinger.remove();
});

function createEvent(sibling){
    // clone, and remove template identification
    var newEvent = $("#EventTemplate").clone();
    newEvent.addClass("Event");
    newEvent.attr("id", "Event");
    insertNoeticaImage(newEvent.find("#NoeticaContainer"), 22, true);
    
    // add to DOM, show
    var parent
    if (!sibling) {
        parent = $("#EventTemplate").parent();
        parent.append(newEvent);
    } else {
        newEvent.insertAfter(sibling);
    }
    newEvent.show();
}

$(".insertEventButton").live('click', function(){
    var sibling = $(this).parents("#Event");
    createEvent($(sibling));
});
    
$("#createEventButton").click(function(){
    createEvent(null);
    
    /*
    // clone, and remove template identification
    var newEvent = $("#EventTemplate").clone();
    newEvent.attr("id", "Event");
    insertNoeticaImage(newEvent.find("#NoeticaContainer"), 22, true);
    
    // add to DOM, show
    var parent = $("#EventTemplate").parent()
    parent.append(newEvent);
    newEvent.show();
    */
});

$(".deleteEventButton").live("click", function(){
    var thisDelete = $(this);
    var parentEvent = thisDelete.parents(".Event");
    parentEvent.remove()
});

$("#eventType").live('change', function(){
    var pooferSelection = $(this).parents("#Thinger").find("#PooferSelect");
    console.log("value is " + $(this).val());
    if ($(this).val() == "Poof") {
        pooferSelection.show();
    } else {
        pooferSelection.hide();
    }    
});

$(".pooferActive").live('click', function(){
    curThis = $(this);
    if (curThis.hasClass('active')) {
        curThis.removeClass('active');
    } else {
        curThis.addClass('active');
    }
});

function playSequence(){
    // create stop and start events for each Event in the sequence
    var events = $('.Event');
    var prevStartTime = 0;
    var prevEndTime = 0;
    var eventList = [];
    for (var i=0; i<events.length; i++){
        var theEvent = $(events[i]);
        var startTimeType = theEvent.find('select#eventStart');
        console.log(startTimeType.val());
        var startTime = parseInt(theEvent.find('#startDelay').val());
        var duration = parseInt(theEvent.find('#duration').val());
        if (startTimeType.val() == 'afterPreviousStart'){
            startTime = prevStartTime + startTime;
        } else if (startTimeType.val() == 'afterPreviousEnd'){
            startTime = prevEndTime + startTime;
        } else if (startTimeType.val() == 'absoluteTime') {
            startTime = startTime; // noop
        } else {
            console.log("unknown start time type: " + startTime.val());
        }
        var endTime = startTime + duration;
        prevStartTime = startTime;
        prevEndTime   = endTime;
        myObjStart = {"time":startTime, "type":"start", "event":theEvent};
        myObjEnd   = {"time":endTime, "type":"end", "event":theEvent};
        eventList.push(myObjStart);
        eventList.push(myObjEnd);
    }
    // sort in ascending order
    eventList.sort(function(event1, event2){ return event1["time"] - event2["time"]; });
    setTimeout(function(){drawFrame(eventList, 0)}, 1);
}

function drawFrame(eventList, curIdx) {
    var nEvents = eventList.length;
    if (curIdx >= nEvents) {
        return;
    }
    var curEvent = eventList[curIdx];
    var activePoofers = curEvent["event"].find(".poofer.active");
    var bigNoetica = $('#BigNoetica');
    var onOff = (curEvent["type"] == "start");
    for (var i=0; i<activePoofers.length; i++){
        var poofer = activePoofers[i];
        var pooferId = '#' + $(poofer).attr("id");
        var bigPoofer = bigNoetica.find(pooferId);
        if (onOff) {
            if (!bigPoofer.hasClass('active')) {
                bigPoofer.addClass('active');
            }
        } else {
            if (bigPoofer.hasClass('active')){
                bigPoofer.removeClass('active');
            }
        }
    }
    
    if (curIdx + 1 < nEvents) {
        var timeout = eventList[curIdx+1]["time"] - curEvent["time"];
        setTimeout(function(){drawFrame(eventList, curIdx+1)}, timeout);
    }
}


$("#Branch").live('change',function(){
    console.log("Branch change called!!");
    var branch = $(this);
    var poofers = branch.siblings("#Poofer");
    //console.log(poofers);
    var poofer = $(poofers[0]);
    poofer.empty()
    console.log(poofer)
    var val = branch.val();
    if (val == "North") {
        poofer.append($("<option>")
            .val("North")
            .html("North"));
        poofer.append($("<option>")
            .val("East")
            .html("East"));
        poofer.append($("<option>")
            .val("West")
            .html("West"));
        poofer.append($("<option>")
            .val("Top")
            .html("Top"));
    } else if (val == "South") {
        console.log("South!!")
        poofer.append($("<option>")
            .val("South")
            .html("South"));
        poofer.append($("<option>")
            .val("East")
            .html("East"));
        poofer.append($("<option>")
            .val("West")
            .html("West"));
        poofer.append($("<option>")
            .val("Top")
            .html("Top"));
    } else if (val == "East") {
        poofer.append($("<option>")
            .val("East")
            .html("East"));
        poofer.append($("<option>")
            .val("North")
            .html("North"));
        poofer.append($("<option>")
            .val("South")
            .html("South"));
        poofer.append($("<option>")
            .val("Top")
            .html("Top"));
    } else if (val == "West"){
        poofer.append($("<option>")
            .val("West")
            .html("West"));
        poofer.append($("<option>")
            .val("North")
            .html("North"));
        poofer.append($("<option>")
            .val("South")
            .html("South"));
        poofer.append($("<option>")
            .val("Top")
            .html("Top"));
    } else if (val == "Top") {
        poofer.append($("<option>")
            .val("North")
            .html("North"));
        poofer.append($("<option>")
            .val("South")
            .html("South"));
        poofer.append($("<option>")
            .val("East")
            .html("East"));
        poofer.append($("<option>")
            .val("West")
            .html("West"));
        poofer.append($("<option>")
            .val("Top")
            .html("Top"));
    } else if (val == "Bottom") {
        poofer.append($("<option>")
            .val("North")
            .html("North"));
        poofer.append($("<option>")
            .val("South")
            .html("South"));
        poofer.append($("<option>")
            .val("East")
            .html("East"));
        poofer.append($("<option>")
            .val("West")
            .html("West"));
    }
});


</script>

